name: Deploy to Production

on:
  push:
    branches: [main, master]
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          script_stop: true
          script: |
            echo "=== Starting deployment ==="
            cd /opt/vdocs

            echo "=== Pulling latest code ==="
            git fetch origin
            git checkout ${{ github.ref_name }}
            git reset --hard origin/${{ github.ref_name }}

            echo "=== Building Docker images ==="
            docker compose build

            echo "=== Restarting services ==="
            docker compose up -d

            echo "=== Waiting for services to start ==="
            sleep 15

            echo "=== Running health checks ==="
            curl -f http://localhost:8000/health || (echo "Backend health check failed!" && exit 1)
            curl -f http://localhost:3000 || (echo "Frontend health check failed!" && exit 1)

            echo "=== Deployment successful! ==="
